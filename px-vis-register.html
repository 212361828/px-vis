<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-colors-design/colors.html" />
<link rel="import" href="px-vis-common.html" />
<link rel="import" href="px-vis-svg-chart-common.html" />
<link rel="import" href="../numbro-element/numbro-element.html" />
<link rel="import" href="../px-tooltip/px-tooltip.html" />

<script src="../moment/moment.js"></script>

<!--
Element providing solution to no problem in particular. As a simple, increments a counter when clicked.

##### Usage

    <px-vis counter-value="1">Hi</px-vis>

@element px-vis-register
@blurb Element providing solution to no problem in particular.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-vis-register">
  <link rel="import" type="css" href="css/px-vis-register.css"/>
  <template>
    <template is="dom-if" if="{{_typeEqualHorizontal(type)}}">
      <div
        id="registerWrap"
        class="flex flex--col"
        style$="height:{{height}}px; width:{{width}}px">
        <div id="dateTime">
          <span id="firstDateTime">{{_firstDateTime}}</span> <span>{{_separator}}</span> <span id="secondDateTime">{{_secondDateTime}}</span>  &nbsp;
        </div>
        <div class="flex flex--row">
          <template is="dom-repeat" items="{{tooltipData.series}}">
            <span class="series narrow flex flex--row" name$="{{item.name}}" on-click="_seriesClicked">
                <span
                  class="seriesMarker"
                  style$="background-color:{{_returnItemColor(index)}};"
                  name$="{{item.name}}"
                >&nbsp;</span>
                <span>
                  <div class="seriesName" name$="{{item.name}}">
                    {{_truncateName(item.name,truncationLength)}}
                    <template is="dom-if" if="{{_didTruncate(item.name,truncationLength)}}">
                      <px-tooltip delay="500">{{item.name}}</px-tooltip>
                    </template>
                  </div>
                  <div class="seriesData" name$="{{item.name}}">
                    <numbro-element
                      value="[[item.value]]"
                      format="[[numberFormat]]"
                      culture="[[numberFormatCulture]]"
                      currency$="[[numberFormatIsCurrency]]"
                      default-currency-format="[[numberFormatCurrency]]"
                      zero-format="[[numberFormatZero]]">
                    </numbro-element>
                  </div>
                </span>
            </span>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="{{!_typeEqualHorizontal(type)}}">
      <div
        id="registerWrap"
        class="flex flex--col u-ml"
        style$="height:{{height}}px; width:{{width}}px">
        <div id="dateTime">
          <span id="firstDateTime">{{_firstDateTime}}</span> <span>{{_separator}}</span> <span id="secondDateTime">{{_secondDateTime}}</span>  &nbsp;
        </div>
        <template is="dom-repeat" items="{{tooltipData.series}}">
          <div class="series wide flex flex--row" name$="{{item.name}}" on-click="_seriesClicked">
            <span
              class="seriesMarker"
              style$="background-color:{{_returnItemColor(index)}};"
              name$="{{item.name}}"
            >&nbsp;</span><span class="seriesName" name$="{{item.name}}">
              {{_truncateName(item.name,truncationLength)}}
              <template is="dom-if" if="{{_didTruncate(item.name,truncationLength)}}">
                <px-tooltip delay="250">{{item.name}}</px-tooltip>
              </template>
            </span>
            <span class="seriesData" name$="{{item.name}}">
              <numbro-element
                value="[[item.value]]"
                format="[[numberFormat]]"
                culture="[[numberFormatCulture]]"
                currency$="[[numberFormatIsCurrency]]"
                default-currency-format="[[numberFormatCurrency]]"
                zero-format="[[numberFormatZero]]">
              </numbro-element>
            </span>
          </div>
        </template>
      </div>
    </template>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-register',

    behaviors: [
      pxVisCommonBehavior,
      pxVisSVGChartCommonBehavior, //Need to add definition for mutedSeries property...
      commonColors
    ],

    /**
     * Properties block, expose attribute values to the DOM via 'reflect'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
       * Data reported back by the tooltip
       *
       * @property tooltipData
       * @type Object
       * @default []
       */
      tooltipData:{
        type:Object,
        observer:'_formatDateTime'
      },
      /**
       * Defines if the register should be horizontal or vertical
       *
       * @property type
       * @type string
       * @default vertical
      */
      type:{
       type:String,
       value:"vertical"
      },
      /**
       * Defines if the names in the register should get truncated and to how many characters.
       *
       * Default length is 10 characters, not including the ellipsis which gets inserted.
       *
       * The length must be at least 2.
       *
       * To disable truncation, set the value to -1
       *
       * @property truncationLength
       * @type Number
       * @default 10
      */
      truncationLength:{
       type:Number,
       value:10
      },

      /**
       * Defines the format for the first datetime string. The first datetime is shown in normal font weight.
       *
       * Default is the first datetime string is TIME presented as "12:00:00 +0000"
       *
       * For valid string formats, see: http://momentjs.com/docs/#/displaying/
       *
       * @property firstDateTimeFormat
       * @type string
       * @default hh:mm:ss ZZ
      */
      firstDateTimeFormat:{
        type:String,
        value: 'hh:mm:ss ZZ'
      },
      /**
       * Defines the format for the second datetime string. The second datetime is shown in bold font weight.
       *
       * Default is the second datetime string is DATE presented as "12 Feb 2016"
       *
       * For valid string formats, see: http://momentjs.com/docs/#/displaying/
       *
       * @property secondDateTimeFormat
       * @type string
       * @default DD MMM YYYY
      */
      secondDateTimeFormat:{
        type:String,
        value:'DD MMM YYYY'
      },

      /**
       * Defines a separator character between the two datetime strings.
       *
       * @property separator
       * @type string
       * @default |
      */
      separator:{
        type:String,
        value:'|'
      },
      /**
       * Holder for the formated first datetime string
       *
       * @property _firstDateTime
       * @type string
      */
      _firstDateTime:{
        type:String,
        notify:true
      },
      /**
       * Holder for the formated second datetime string
       *
       * @property _secondDateTime
       * @type string
      */
      _secondDateTime:{
        type:String,
        notify:true
      },
      /**
       * Holder for the formated separator character
       *
       * @property _separator
       * @type string
      */
      _separator:{
        type:String,
        notify:true
      },
    },

    observers: [
      '_toggleSeries(mutedSeries.*)'
     ],

    /**
     * Function which returns true if type equals horizontal
     *
     * @method _typeEqualHorizontal
     */
    _typeEqualHorizontal: function(type){
      return type === 'horizontal'
    },
    /**
     * Function which takes an index and returns the appropriate dataVisColor
     *
     * @method _returnItemColor
     */
    _returnItemColor:function(i){
      return this.dataVisColors[ this.seriesColorOrder[i] ]
    },
    /**
     * Function which takes the incoming datetime from tooltipData and formats it.
     *
     * @method _formatDateTime
     */
    _formatDateTime:function(){
      if(this.tooltipData.time){
        var momentObj = moment(this.tooltipData.time);

        this.set('_firstDateTime', momentObj.format(this.firstDateTimeFormat));
        this.set('_secondDateTime', momentObj.format(this.secondDateTimeFormat));
        this.set('_separator', this.separator);

      } else {
        this.set('_firstDateTime', '');
        this.set('_secondDateTime', '');
        this.set('_separator', '');
      }
    },
    _seriesClicked:function(e){
      var ne = Polymer.dom(e);
      var series = ne.rootTarget.getAttribute('name');

      // if it doesnt exist, let's add it and set to true
      if( typeof(this.mutedSeries[series]) === 'undefined' ){
        this.set('mutedSeries.' + series, true);
      } else {
        //if does exist, flip the bit
        this.set('mutedSeries.' + series, !this.mutedSeries[series]);
      }

      e.stopPropagation();
    },
    _toggleSeries: function(){
      // find all series with name and toggle class
      var keys = Object.getOwnPropertyNames(this.mutedSeries);
      for(var i = 0; i < keys.length; i++){
        var series = this.$$('.series[name=' + keys[i] + ']');
        this.toggleClass('muted', this.mutedSeries[keys[i]], series)
      }
    },
    _didTruncate:function(str,len){
      if(len > 2 || str > len){
        return true;
      }

      return false;
    }
  });
</script>
