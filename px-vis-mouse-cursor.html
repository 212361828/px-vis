<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-vis-behavior-common.html" />
<link rel="import" href="px-vis-behavior-d3.html" />
<link rel="import" href="../px-colors-design/colors.html" />
<link rel="import" href="fa_codes.html" />


<!--
Element which draws crosshairs around mouse pointer / data points and highlights adjacent datapoints.
- Uses tooltipData property.

##### Usage

  <px-vis-svg
    width="[[width]]"
    height="[[height]]"
    margin="[[margin]]"
    svg="{{svg}}">
  </px-vis-svg>
  <px-vis-scale
    x-axis-type="time"
    y-axis-type="linear"
    complete-series-config="[[seriesConfig]]"
    data-extents="[[dataExtents]]"
    width="[[width]]"
    height="[[height]]"
    margin="[[margin]]"
    chart-data={{chartData}}
    x="{{x}}"
    y="{{y}}"
    domain-changed="{{domainChanged}}"
    selected-domain="[[selectedDomain]]">
  </px-vis-scale>
  <px-vis-interaction-space
    x-axis-type="time"
    svg="[[svg]]"
    width="[[width]]"
    height="[[height]]"
    margin="[[margin]]"
    complete-series-config="[[seriesConfig]]"
    chart-data="[[chartData]]"
    tooltip-data={{tooltipData}}
    series-keys="[[seriesKeys]]"
    extents-data={{extentsData}}
    x="[[x]]"
    y="[[y]]"
    domain-changed="[[domainChanged]]">
  </px-vis-interaction-space>
  <px-vis-mouse-cursor
    svg="[[svg]]"
    width="[[width]]"
    height="[[height]]"
    margin="[[margin]]"
    complete-series-config="[[seriesConfig]]"
    chart-data="[[chartData]]"
    tooltip-data="[[tooltipData]]"
    selection-type=[[selectionType]]>
  </px-vis-mouse-cursor>

### Styling
The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
  `--px-vis-cursor-line-color` | The color for the lines which track the cursor/data | `$gray5`


@element px-vis-cursor
@blurb Element which draws crosshairs around mouse pointer / data points and highlight adjacent datapoints.
@homepage index.html
@demo demo/index.html

//TODO implement a dev setting to choose between only showing data at that x, snapping to nearest data, or interpolating value at x

-->

<link rel="import" href="css/px-vis-styles.html">

<dom-module id="px-vis-mouse-cursor">
    <template>
      <style include="px-vis-styles"></style>
    </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-mouse-cursor',

    behaviors: [
      PxVisBehaviorD3.svg,
      PxVisBehavior.commonMethods,
      PxVisBehavior.tooltipData,
      PxVisBehaviorD3.clipPath,
      PxColorsBehavior.baseColors,
      PxVisBehavior.polarData
    ],

    /**
     * Properties block, expose attribute values to the DOM via 'reflect'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
       * Holder for the cursor drawing objects
       *
       * @property _cursor
       * @type Object
       */
      _cursor:{
        type:Object
      },
      /**
       * Holder for the icon drawing object
       *
       */
      _icon:{
        type:Object
      },
      /**
       * Holder for the drawing object
       *
       */
      _customCursor:{
        type:Object
      },

      _lastIcon: {
        type: String,
        value: 'none'
      },

      _lastCursor: {
        type: String,
        value: 'none'
      },

      /**
       * Name of the icon type
       */
      iconType: {
        type: String,
        value: 'none'
      },
      /**
       * Type of cursor drawing to add:
       *  - 'none' //default
       *  - 'crosshair' : draws vertical and horizonal line
       *  - 'circle' : draws circle of size radius
       */
      cursorType: {
        type: String,
        value: 'none'
      },

      /**
       * Whether the scatter plot is using radial coordinates (x=phase, y=amplitude)
       */
      radial: {
        type: Boolean,
        value: false
      },

      /**
       * radius of the circle cursor
       */
      radius: {
        type: Number,
        value: 0
      },

    }, //properties

    observers: [
      'drawElement(svg, tooltipData.mouse.*)'
    ],

    /**
     * Draws the tooltip elements and sets up listeners and callbacks on chart hover
     * Sets the tooltipData property which gets passed to the register.
     *
     * @method drawElement
     */
    drawElement: function() {
      // add circle to the line and hide it
      if(!this._cursor) {
        this._cursor = this.svg.append('g');
      }

      if(this._lastIcon !== this.iconType) {
        this._drawIcon();
      }

      if(this.cursorType !== this._lastCursor) {
        this._drawCursor();
      }

      this._cursor
        .attr('display', function() { return this.tooltipData.mouse ? null : 'none' }.bind(this));

      this._icon
        .attr("x", this.tooltipData.mouse[0] + 5)
        .attr("y", this.tooltipData.mouse[1] - 5);

      // this._customCursor

    },  //drawElement

    _drawIcon: function() {
      var icon = this.iconType  ? String.fromCharCode(parseInt(this.fa[this.iconType],16)) : '';
      this._icon = this.eventGroup.append("text")
        .attr('font-family', 'FontAwesome')
        .attr('font-size', '10px')
        .attr('fill', this._checkThemeVariable("--px-vis-cursor-line-color", this.colors.gray5))
        .text(icon);

      this._addClipPath(this._icon);
    },

    _drawCursor: function() {

      if(!this.cursorType && this._doesD3HaveValues(this._customCursor)) {
        this._customCursor.remove();
      }

      if(this.cursorType === 'circle') {
        this._cursor
          .append("circle")
          .attr("class", "mouseCursor")
          .attr('fill', this._checkThemeVariable('--px-vis-zoom-brush-fill-color', this.colors.grey2))
          .attr('fill-opacity', this._checkThemeVariable('--px-vis-zoom-brush-fill-opacity', 0.5))
          .attr('stroke', this._checkThemeVariable('--px-vis-zoom-brush-outline-color', this.colors.grey6));
          .attr("r", this.radius)
          .attr("cx", 0)
          .attr("cy", 0);
      }

      if(this.cursorType === 'crosshair') {
        this._cursor
          .append('line')
          .attr('class', 'mouseCursor')
          .attr('stroke', this._checkThemeVariable("--px-vis-cursor-line-color", this.colors.gray5))
          .attr('stroke-width', 2)
          .attr('opacity', 1)
          .attr('x1', 0)
          .attr('x2', 0)
          .attr('y1', 0)
          .attr('y2', 0);

        this._cursor
          .append('line')
          .attr('class', 'mouseCursor')
          .attr('stroke', this._checkThemeVariable("--px-vis-cursor-line-color", this.colors.gray5))
          .attr('stroke-width', 2)
          .attr('opacity', 1)
          .attr('x1', 0)
          .attr('x2', 0)
          .attr('y1', 0)
          .attr('y2', 0);

      }

      this._customCursor = this._cursor.selectAll('.mouseCursor');
      this._addClipPath(this._customCursor);
    },


    _addClipPath: function(elem) {
      if(this.clipPath) {
        this.addClipPath(elem);
      }
    }
  });
</script>
